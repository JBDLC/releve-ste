{% extends 'layout.html' %}

{% block extra_head %}
<!-- Handsontable CSS -->
<link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
<style>
.hot-container {
    margin: 20px 0;
    width: 100%;
    height: 500px;
    overflow: visible;
}
.toolbar {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}
.toolbar button {
    margin-right: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <a href="{{ url_for('index') }}" class="btn btn-secondary mb-3">
        <i class="fas fa-home"></i> Retour à l'accueil
    </a>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Gestion du fichier Excel</h2>
        <select name="site" id="site" class="form-select" style="width: auto;" onchange="window.location.href='/gestion_excel?site=' + this.value">
            {% for s in sites %}
                <option value="{{ s }}" {% if s == site %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="toolbar mb-3">
        <button id="add-row" class="btn btn-success">
            <i class="fas fa-plus"></i> Ajouter une ligne
        </button>
        <button id="remove-row" class="btn btn-danger">
            <i class="fas fa-trash"></i> Supprimer la(les) ligne(s)
        </button>
        <button id="save" class="btn btn-primary">
            <i class="fas fa-save"></i> Enregistrer
        </button>
    </div>

    <div id="hot-container" class="hot-container"></div>

    {% if message %}
        <div class="alert alert-success mt-3">{{ message }}</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Handsontable JS -->
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ df.to_json(orient='records') | safe }};
    const columns = {{ df.columns.tolist() | tojson | safe }};
    
    const container = document.getElementById('hot-container');
    const hot = new Handsontable(container, {
        data: data,
        colHeaders: columns,
        rowHeaders: true,
        height: '100%',
        width: 'auto',
        stretchH: 'all',
        contextMenu: ['row_above', 'row_below', 'remove_row', 'undo', 'redo', 'copy', 'cut', 'paste'],
        manualRowResize: true,
        manualColumnResize: true,
        manualRowMove: true,
        manualColumnMove: true,
        columnSorting: true,
        filters: true,
        dropdownMenu: true,
        multiSelect: true,
        fillHandle: true,
        outsideClickDeselects: false,
        selectionMode: 'multiple',
        enterBeginsEditing: true,
        licenseKey: 'non-commercial-and-evaluation'
    });

    // Ajouter une ligne
    document.getElementById('add-row').addEventListener('click', function() {
        hot.alter('insert_row');
        hot.render(); // Forcer le rendu
    });

    // Supprimer les lignes sélectionnées
    document.getElementById('remove-row').addEventListener('click', function() {
        const selected = hot.getSelected();
        if (!selected) return;
        
        const rowsToRemove = new Set();
        selected.forEach(range => {
            const [startRow, , endRow] = range;
            for (let row = startRow; row <= endRow; row++) {
                rowsToRemove.add(row);
            }
        });
        
        const rowsArray = Array.from(rowsToRemove).sort((a, b) => b - a);
        rowsArray.forEach(row => {
            hot.alter('remove_row', row);
        });
        hot.render(); // Forcer le rendu
    });

    // Sauvegarder les modifications
    document.getElementById('save').addEventListener('click', function() {
        const data = hot.getData();
        const headers = hot.getColHeader();
        
        fetch('/gestion_excel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                site: '{{ site }}',
                data: data,
                headers: headers
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Données sauvegardées avec succès !');
            } else {
                alert('Erreur lors de la sauvegarde : ' + result.error);
            }
        })
        .catch(error => {
            alert('Erreur lors de la sauvegarde : ' + error);
        });
    });
});
</script>
{% endblock %} 